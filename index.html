<!DOCTYPE html>
<html>
<head>
    <title>Radio Stream</title>
    <meta charset="UTF-8">
    <style>
        body {
            font-family: Times New Roman, serif;
            background-color: white;
            color: black;
            margin: 20px;
            font-size: 14px;
        }
        
        h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        button {
            font-family: Times New Roman, serif;
            font-size: 14px;
            padding: 5px 15px;
            margin: 5px;
            background-color: #eeeeee;
            border: 2px outset #eeeeee;
            cursor: pointer;
        }
        
        button:active {
            border: 2px inset #eeeeee;
        }
        
        .status {
            margin: 10px 0;
            font-weight: bold;
        }
        
        .info {
            margin: 15px 0;
            font-size: 12px;
            color: #666666;
        }
    </style>
</head>
<body>
    <h1>Radio Stream</h1>
    
    <button onclick="tuneIn()">TUNE IN</button>
    <button onclick="tuneOut()">TUNE OUT</button>
    
    <div class="status" id="status">Ready to tune in...</div>
    
    <div class="info">
        <p>Click "TUNE IN" to join the ongoing radio stream.</p>
        <p>Everyone hears the same thing at the same time.</p>
        <p>Stream position: <span id="position">--:--</span></p>
    </div>
    
    <audio id="radioStream" preload="none">
        <source src="https://meek-fox-78808e.netlify.app/audio/test.mp3" type="audio/mpeg">
        Your browser does not support the audio element.
    </audio>

    <script>
        const audio = document.getElementById('radioStream');
        const statusDiv = document.getElementById('status');
        const positionSpan = document.getElementById('position');
        
        // Radio loop configuration
        const LOOP_DURATION = 109; // 3 minutes (adjust based on your actual file length)
        const STREAM_START_TIME = new Date('2025-01-01T00:00:00Z'); // Arbitrary reference point
        
        let isPlaying = false;
        let positionInterval;
        
        function getCurrentStreamPosition() {
            const now = new Date();
            const elapsed = (now - STREAM_START_TIME) / 1000; // seconds since stream "started"
            return elapsed % LOOP_DURATION; // current position in loop
        }
        
        function updatePositionDisplay() {
            if (isPlaying) {
                const position = getCurrentStreamPosition();
                const minutes = Math.floor(position / 60);
                const seconds = Math.floor(position % 60);
                positionSpan.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }
        }
        
        function tuneIn() {
            if (isPlaying) return;
            
            statusDiv.textContent = "Tuning in...";
            
            // Calculate where we should be in the stream
            const streamPosition = getCurrentStreamPosition();
            
            audio.currentTime = streamPosition;
            audio.loop = true;
            
            audio.play().then(() => {
                isPlaying = true;
                statusDiv.textContent = "Now playing - Live stream";
                
                // Update position display every second
                positionInterval = setInterval(updatePositionDisplay, 1000);
                updatePositionDisplay();
                
            }).catch(error => {
                statusDiv.textContent = "Error: Could not connect to stream";
                console.log('Playback error:', error);
            });
        }
        
        function tuneOut() {
            if (!isPlaying) return;
            
            audio.pause();
            isPlaying = false;
            statusDiv.textContent = "Stream stopped";
            positionSpan.textContent = "--:--";
            
            if (positionInterval) {
                clearInterval(positionInterval);
            }
        }
        
        // Handle audio events
        audio.addEventListener('loadstart', () => {
            if (isPlaying) statusDiv.textContent = "Connecting to stream...";
        });
        
        audio.addEventListener('canplay', () => {
            if (isPlaying) statusDiv.textContent = "Now playing - Live stream";
        });
        
        audio.addEventListener('error', () => {
            statusDiv.textContent = "Connection failed";
            isPlaying = false;
        });
        
        // Sync correction - if audio gets out of sync, resync every 30 seconds
        setInterval(() => {
            if (isPlaying && !audio.paused) {
                const expectedPosition = getCurrentStreamPosition();
                const actualPosition = audio.currentTime;
                const drift = Math.abs(expectedPosition - actualPosition);
                
                // If we're more than 2 seconds off, resync
                if (drift > 2) {
                    audio.currentTime = expectedPosition;
                }
            }
        }, 30000);
    </script>
</body>
</html>
